<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Advanced AR Cam</title>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<style>
body{
margin:0;
overflow:hidden;
height:100vh;
display:flex;
flex-direction:column;
background:linear-gradient(135deg,#ff9ad5,#c774ff);
font-family:sans-serif;
}

h2{
text-align:center;
margin:4px;
color:white;
}

#container{
position:relative;
height:60vh;
}

video,canvas{
position:absolute;
width:100%;
height:100%;
object-fit:cover;
}

.controls{
display:grid;
grid-template-columns:repeat(4,1fr);
gap:6px;
padding:6px;
}

button{
padding:8px;
border:none;
border-radius:20px;
background:linear-gradient(45deg,#ff4fd8,#7a5cff);
color:white;
font-size:12px;
}

.footer{
text-align:center;
font-size:12px;
color:white;
padding:4px;
}
</style>
</head>

<body>

<h2>Advanced AR Cam</h2>

<div id="container">
<video id="video" autoplay playsinline></video>
<canvas id="canvas"></canvas>
</div>

<div class="controls">
<button onclick="setEffect('crown')">Crown</button>
<button onclick="setEffect('bunny')">Bunny</button>
<button onclick="setEffect('mask')">Full Mask</button>
<button onclick="setEffect('swap')">Face Swap</button>
<button onclick="capture()">Capture</button>
<button onclick="shareImage()">Share</button>
<button onclick="resetEffect()">Reset</button>
</div>

<div class="footer">Created by Animesh</div>

<script>
const video=document.getElementById("video");
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");

let currentEffect=null;
let capturedBlob=null;

navigator.mediaDevices.getUserMedia({video:{width:640,height:480}})
.then(stream=>{video.srcObject=stream});

const faceMesh=new FaceMesh({
locateFile:(file)=>`https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`
});

faceMesh.setOptions({
maxNumFaces:2,
refineLandmarks:true,
minDetectionConfidence:0.5,
minTrackingConfidence:0.5
});

faceMesh.onResults(results=>{
canvas.width=video.videoWidth;
canvas.height=video.videoHeight;

ctx.clearRect(0,0,canvas.width,canvas.height);
ctx.drawImage(video,0,0,canvas.width,canvas.height);

if(!results.multiFaceLandmarks) return;

if(currentEffect==="swap" && results.multiFaceLandmarks.length===2){
faceSwap(results.multiFaceLandmarks);
}else{
results.multiFaceLandmarks.forEach(landmarks=>{
if(currentEffect==="crown") drawCrown(landmarks);
if(currentEffect==="bunny") drawBunny(landmarks);
if(currentEffect==="mask") drawMask(landmarks);
});
}
});

const camera=new Camera(video,{
onFrame:async()=>{await faceMesh.send({image:video});},
width:640,
height:480
});
camera.start();

function setEffect(e){currentEffect=e;}
function resetEffect(){currentEffect=null;}

function getHeadData(landmarks){
const leftEye=landmarks[33];
const rightEye=landmarks[263];

const dx=(rightEye.x-leftEye.x)*canvas.width;
const dy=(rightEye.y-leftEye.y)*canvas.height;

const angle=Math.atan2(dy,dx);
const width=Math.sqrt(dx*dx+dy*dy)*2.5;

const centerX=(leftEye.x+rightEye.x)/2*canvas.width;
const centerY=(leftEye.y+rightEye.y)/2*canvas.height;

return {centerX,centerY,width,angle};
}

function drawCrown(landmarks){
const {centerX,centerY,width,angle}=getHeadData(landmarks);

ctx.save();
ctx.translate(centerX,centerY-width*0.6);
ctx.rotate(angle);
ctx.fillStyle="gold";
ctx.beginPath();
ctx.moveTo(-width/2,0);
ctx.lineTo(-width/4,-width/2);
ctx.lineTo(0,0);
ctx.lineTo(width/4,-width/2);
ctx.lineTo(width/2,0);
ctx.closePath();
ctx.fill();
ctx.restore();
}

function drawBunny(landmarks){
const {centerX,centerY,width,angle}=getHeadData(landmarks);

ctx.save();
ctx.translate(centerX,centerY-width*0.9);
ctx.rotate(angle);
ctx.fillStyle="white";
ctx.fillRect(-width/4,-width,width/6,width);
ctx.fillRect(width/8,-width,width/6,width);
ctx.restore();
}

function drawMask(landmarks){
const {centerX,centerY,width,angle}=getHeadData(landmarks);

ctx.save();
ctx.translate(centerX,centerY);
ctx.rotate(angle);
ctx.fillStyle="rgba(255,105,180,0.4)";
ctx.beginPath();
ctx.arc(0,0,width/1.5,0,Math.PI*2);
ctx.fill();
ctx.restore();
}

function faceSwap(faces){
const face1=faces[0];
const face2=faces[1];

const p1=getHeadData(face1);
const p2=getHeadData(face2);

ctx.save();
ctx.globalAlpha=0.7;
ctx.drawImage(video,
p1.centerX-p1.width/2,p1.centerY-p1.width/2,p1.width,p1.width,
p2.centerX-p2.width/2,p2.centerY-p2.width/2,p2.width,p2.width);
ctx.restore();
}

function capture(){
canvas.toBlob(blob=>{
capturedBlob=blob;
alert("Captured!");
});
}

async function shareImage(){
if(!capturedBlob){alert("Capture first!");return;}

const file=new File([capturedBlob],"arcam.png",{type:"image/png"});

if(navigator.share){
await navigator.share({
files:[file],
title:"Advanced AR Cam",
text:"Look at this cool AR effect!"
});
}else{
alert("Sharing not supported on this device");
}
}
</script>

</body>
</html>
